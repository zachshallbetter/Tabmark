$(document).ready(function(){getUser(function(a){LOGIN_URL=a.login;LOGOUT_URL=a.logout;var d=a.tasks;if(d){setTasksView(d)}$("#save_task").click(function(){saveTask($("#task_name").val(),true)});$("#task_name").keypress(function(e){if(e.which==13){saveTask($("#task_name").val(),true)}});$("#auto_update").click(setUpdate);$("#errors").addClass("ui-state-error ui-corner-all");$("#task_name").blur(function(){$("#errors").hide()});$("button").button();if(!a.email||a.email=="default"){var c=$("<a></a>");c.attr("href",LOGIN_URL);c.attr("target","_blank");c.text("Log in");var b=$("<span></span>");b.append(c);b.append(" to enable cloud syncing");$("#username").append(b)}else{$("#username").append("Logged in as: "+a.email);$("#username").append("<br>");var c=$("<a></a>");c.attr("href",LOGOUT_URL);c.attr("target","_blank");c.text("Log out");$("#username").append(c)}})});function editTitle(h,c,e,d){var g=e.siblings(".name_text");var b=g.text();var a=$("<input />");var f=function(){var i=a.val();c.name=i;d.attr("id","task_name_"+i);getUser(function(j){j.tasks=h;setUser(j,false)});g.text(i);a.replaceWith(g);e.removeClass("ui-icon-check");e.addClass("ui-icon-pencil");e.unbind("click");e.click(function(){return editTitle(h,c,e,d)});return false};a.attr("type","text");a.addClass("task-name-edit");a.val(b);g.replaceWith(a);e.removeClass("ui-icon-pencil");e.addClass("ui-icon-check");e.unbind("click");e.click(f);a.click(function(){return false}).keydown(function(j){var i=j.which;if(i==13){return f()}else{if(i==32){$(this).val($(this).val().trim()+" ");return false}}}).blur(function(){return f()}).autoGrowInput({comfortZone:5,minWidth:10,maxWidth:140}).focus();return false}function showError(b){$("#errors").html("");var a=$("<strong>Error: </strong>");$("#errors").show().append(a).append(b)}function refreshAccordion(){$("#tasks").accordion("destroy").accordion({header:"> div > h3",collapsible:true,active:false,autoHeight:false}).sortable({axis:"y",handle:"h3",update:saveList});$("button").button()}function saveList(a,b){getUser(function(d){var e=d.tasks;var c=[];var f=$(".task_name > a > span > .name_text");$.each(f,function(g,h){c.push(e.slice(indexOfTask(e,$(h).html()))[0])});d.tasks=c;setUser(d)})}function setTasksView(a){$("#tasks").html("");$.each(a,function(c,b){if(b){addTaskView(a,b)}})}function addTaskView(k,o){var q=o.tabs;var f=o.update;var a=$("<div></div>");var v=$("<div></div>");v.addClass("task_contents");a.addClass("task");a.attr("id","task_name_"+o.name);var c=$("<h3></h3>");c.addClass("task_name");var p=$("<a></a>");p.attr("href","#");var i=$("<span></span>");i.addClass("name_text");i.text(unescape(o.name));var h=$("<span></span>");h.addClass("ui-icon ui-icon-pencil icon-title");h.unbind("click");h.click(function(){return editTitle(k,o,$(this),v)});var u=$("<span></span>");u.append(i);u.append(h);p.append(u);c.append(p);a.append(c);var r=$("<a></a>");r.addClass("io");r.html("Save");r.click(function(){saveTask(o.name,false,true);return false});var e=$("<a></a>");e.addClass("io");e.html("Load");e.click(function(){loadTask(o);return false});p.append(r);p.append(e);chrome.windows.getCurrent(null,function(w){chrome.extension.sendRequest({type:"window_active",name:o.name,window:w.id},function(x){if(x.response){var y=$("<span></span>");y.attr("id","recording");y.addClass("ui-icon ui-icon-bullet icon-title");y.attr("title","This task is active in this window and live syncing is disabled. Changes to your current tabs will not be saved automatically.");if(o.update){y.addClass("ui-icon-red");y.attr("title","This task is active in this window and live syncing is enabled. Changes to your current tabs will be saved live.")}u.append(y)}})});var l=$("<p></p>");l.addClass("description");if(o.description){l.text(o.description)}else{l.text("Click to add a description");l.addClass("no_description")}var j=function(y){var w=$("<input>");if(!l.hasClass("no_description")){w.val(l.text())}w.attr("type","text");w.addClass("task-name-edit edit-input-centered");l.html(w);var x=function(){getUser(function(z){z.tasks[indexOfTask(z.tasks,o.name)].description=w.val();setUser(z,false)});if(w.val()){l.text(w.val());l.removeClass("no_description")}else{l.text("Click to add a description");l.addClass("no_description")}};w.blur(x).keypress(function(z){if(z.keyCode==13){x()}}).click(function(){return false}).focus()};l.click(function(){j($(this))});v.append(l);var s=$("<ul></ul>");s.attr("class","tablist");$.each(q,function(B,A){var w=$("<li></li>");var x=$("<a></a>");var z=$("<img />");var y=$("<span></span>");y.addClass("ui-icon ui-icon-close");y.click(function(D){var C=$(this);C.parent().remove();getUser(function(E){var G=E.tasks[indexOfTask(E.tasks,o.name)];var F=getTab(G.tabs,C.siblings("a").attr("href"));delete G.tabs[F];setUser(E)})}).hover(function(C){$(this).toggleClass("ui-icon-close");$(this).toggleClass("ui-icon-circle-close")});x.attr("href",A.url);x.attr("target","_blank");x.attr("title",A.url);z.attr("src",A.favicon);z.attr("width","16px");z.attr("height","16px");x.append(z);if(A.title.length>30){x.append(A.title.substring(0,30)+"...")}else{x.append(A.title)}w.append(x);w.append(y);s.append(w);w.click(function(C){chrome.tabs.create({url:A.url,active:true});return false})});v.append(s);var g=$("<div></div>");g.addClass("optionsDiv");var t=$("<button>Remove Task</button>");t.click(function(){removeTask(o.name);return false});var b=o.name+"_sync_button";var d=$("<label></label>");var m=$("<span></span>");m.addClass("ui-icon icon-button");m.addClass(o.update?"ui-icon-check":"ui-icon-radio-on");d.append(m);d.append("Update Live");d.attr("for",b);var n=$("<input />");n.attr("id",b);n.attr("type","checkbox");if(o.update){n.attr("checked","checked")}n.val(o.name);n.change(function(){setUpdate(d,$(this))});g.append(t);g.append(n);g.append(d);v.append(g);a.append(v);$("#tasks").append(a);n.button();t.button();refreshAccordion()}function removeTask(a){getUser(function(b){var c=indexOfTask(b.tasks,a);b.tasks.splice(c,1);setUser(b);var d=$("#task_name_"+a);if(d.hasClass("active_task")){$("#auto_update").hide()}d.remove();setTasksView(b.tasks)})}function loadTask(a){var b=new Array();$.each(a.tabs,function(d,c){b.push(c.url)});if(a.update){deleteTabsFromTask(a)}chrome.windows.create({url:b,focused:true},function(c){saveTask();addToUpdater(c,a.name)})}function setUpdate(b,c){var a=c.attr("checked");if(a){$("#recording").attr("title","This task is active in this window and live syncing is enabled. Changes to your current tabs will be saved live.");$("#recording").addClass("ui-icon-red")}else{$("#recording").attr("title","This task is active in this window and live syncing is disabled. Changes to your current tabs will not be saved automatically.");$("#recording").removeClass("ui-icon-red")}getUser(function(d){d.tasks[indexOfTask(d.tasks,c.val())].update=a;b.children().children().removeClass("ui-icon-check, ui-icon-radio-on");b.children().children().addClass(a?"ui-icon-check":"ui-icon-radio-on");setUser(d)})}function addToUpdater(b,a){chrome.extension.sendRequest({type:"load_task",name:a,window:b.id,},function(){})}function setUser(b,a){chrome.extension.sendRequest({type:"set_user",user:b,immediate:a},function(){})}function getUser(a){chrome.extension.sendRequest({type:"get_user"},function(b){a(b)})}function deleteTabsFromTask(a){chrome.extension.sendRequest({type:"delete_tabs",task:a},function(){})}function saveTask(c,a,b){if(!c){showError("Please enter a task name");return}getUser(function(d){if(!d.tasks){d.tasks=[]}if(a&&indexOfTask(tasks,c)>=0){showError("A task with that name already exists");return}else{$("#task_name").attr("value","")}chrome.windows.getCurrent({populate:true},function(g){var f=getTabsFromWindow(g);var e=a?{name:escape(c),update:false,description:""}:d.tasks[indexOfTask(d.tasks,c)];e.tabs=f;if(a){d.tasks.push(e);addToUpdater(g,c)}setTasksView(d.tasks);setUser(d,b)})})};